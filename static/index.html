<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signal Visualization</title>
    <style>
        #signal-plot {
            width: 600px;
            height: 300px;
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h1>Upload .dat File and Visualize Signal Segments</h1>

    <!-- File upload form -->
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">Upload and Process</button>
    
    <!-- Display the message -->
    <p id="message"></p>

    <!-- Segment Controls -->
    <button onclick="fetchSegment(-1)">Previous Segment</button>
    <button onclick="fetchSegment(1)">Next Segment</button>

    <!-- Canvas for visualization -->
    <canvas id="signal-plot"></canvas>

    <script>
        let currentIndex = 0;
        let resultFile = null;

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput').files[0];
            if (!fileInput) {
                alert("Please select a .dat file first.");
                return;
            }

            const formData = new FormData();
            formData.append("file", fileInput);

            try {
                const response = await fetch("http://127.0.0.1:8000/upload_file", {
                    method: "POST",
                    body: formData
                });
                const result = await response.json();
                document.getElementById('message').innerText = result.message;
                resultFile = result.result_file;
                currentIndex = 0; // Reset to the first segment
                fetchSegment(0); // Fetch the first segment
            } catch (error) {
                console.error("Error uploading file:", error);
            }
        }

        async function fetchSegment(direction) {
            // Update the index based on the direction
            currentIndex += direction;

            if (!resultFile) {
                alert("Please upload a file first.");
                return;
            }

            try {
                const response = await fetch(`http://127.0.0.1:8000/get_segments?index=${currentIndex}`);
                const data = await response.json();

                if (data.message === "Index out of range") {
                    alert(data.message);
                    currentIndex -= direction; // Revert index change if out of range
                    return;
                }

                // Display signal segment
                plotSignal(data.segment_signal, data.time_range, data.label);
            } catch (error) {
                console.error("Error fetching segment:", error);
            }
        }

        function plotSignal(signal, timeRange, label) {
            const canvas = document.getElementById("signal-plot");
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.beginPath();
            const scaleX = canvas.width / signal.length;
            const scaleY = canvas.height / (Math.max(...signal) - Math.min(...signal));

            // Plot the signal
            signal.forEach((value, index) => {
                const x = index * scaleX;
                const y = canvas.height - (value - Math.min(...signal)) * scaleY;
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.strokeStyle = "blue";
            ctx.stroke();

            // Display label and time range
            document.getElementById("message").innerText = `Label: ${label}, Time Range: ${timeRange[0]} - ${timeRange[1]}`;
        }
    </script>
</body>
</html>
